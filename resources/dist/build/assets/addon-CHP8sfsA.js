function d(a,s="/cp"){const o=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`^${o}/assets/browse/([^/]+)/(.+?)(?:/edit)?$`),t=a.match(e);return t&&t[1]&&t[2]?`${t[1]}::${t[2]}`:null}function m(a,s="/cp"){return a.startsWith(`${s}/assets/browse/`)}const p="ready",_="pending",x="not_found",g="error",f=1e3,A=15;function l(){return Statamic.$config.get("cpRoot")||"/cp"}async function S(a,s){var o,e;try{const t=l();return(await Statamic.$app.config.globalProperties.$axios.post(`${t}/auto-alt-text/generate`,{asset_path:a,field:s})).data}catch(t){return console.error("Alt text trigger request error:",t),{success:!1,message:((e=(o=t.response)==null?void 0:o.data)==null?void 0:e.message)||t.message||"Error communicating with server."}}}async function $(a,s){var o,e;try{const t=l();return(await Statamic.$app.config.globalProperties.$axios.get(`${t}/auto-alt-text/check`,{params:{asset_path:a,field:s}})).data}catch(t){console.error("Alt text check request error:",t);const r=((e=(o=t.response)==null?void 0:o.data)==null?void 0:e.message)||t.message||"Error checking status.";return{status:g,message:r}}}async function h(a,s,o){let e=0;return new Promise((t,r)=>{const c=window.setInterval(async()=>{if(e++,console.log(`Polling attempt ${e} for ${a}...`),e>A){clearInterval(c),r(new Error(__("auto-alt-text::messages.timeout")));return}const n=await $(a,s);switch(n.status){case p:clearInterval(c),console.log("Alt text ready:",n.caption),Statamic.$toast.success(__("auto-alt-text::messages.success")),o(n.caption),t();break;case _:break;case x:clearInterval(c),r(new Error(n.message||__("auto-alt-text::messages.asset_not_found")));break;case g:default:clearInterval(c),r(new Error(n.message||__("auto-alt-text::messages.polling_error")));break}},f)})}Statamic.booting(()=>{console.log("Statamic Auto Alt Text Addon Initializing...");const s=(Statamic.$config.get("autoAltText")||{}).enabledFields||["alt","alt_text","alternative_text"],o=__("auto-alt-text::messages.generate_alt_text_action");Statamic.$fieldActions.add("text-fieldtype",{title:o,icon:"image",visible:e=>{const t=window.location.pathname;return m(t,l())&&s.includes(e.handle)},run:async e=>{const{handle:t,update:r}=e,c=window.location.pathname,n=d(c,l());if(!n){Statamic.$toast.error(__("auto-alt-text::messages.cannot_determine_asset_path"));return}try{Statamic.$toast.info(__("auto-alt-text::messages.generation_started"));const i=await S(n,t);if(!i.success){const u=i.message||__("auto-alt-text::messages.trigger_failed");Statamic.$toast.error(u);return}await h(n,t,r)}catch(i){console.error("Error during alt text generation:",i),Statamic.$toast.error(i.message||__("auto-alt-text::messages.unexpected_error"))}}}),console.log("Statamic Auto Alt Text Field Action Registered for text-fieldtype.")});
