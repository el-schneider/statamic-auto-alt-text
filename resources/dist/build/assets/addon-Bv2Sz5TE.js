function g(e="/cp"){return e===""||e==="/"?"":(e.startsWith("/")?e:`/${e}`).replace(/\/+$/,"")}function m(e,o="/cp"){const s=g(o).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),t=new RegExp(`^${s}/assets/browse/([^/]+)/(.+?)(?:/edit)?/?$`),a=e.match(t);return a&&a[1]&&a[2]?`${a[1]}::${a[2]}`:null}function p(e,o="/cp"){const r=g(o);return e.startsWith(`${r}/assets/browse/`)}const _="ready",x="pending",f="not_found",u="error",h=1e3,A=15;function l(){return g(Statamic.$config.get("cpRoot")||"/cp")}async function S(e,o){var r,s;try{const t=l();return(await Statamic.$app.config.globalProperties.$axios.post(`${t}/auto-alt-text/generate`,{asset_path:e,field:o})).data}catch(t){return console.error("Alt text trigger request error:",t),{success:!1,message:((s=(r=t.response)==null?void 0:r.data)==null?void 0:s.message)||t.message||"Error communicating with server."}}}async function $(e,o){var r,s;try{const t=l();return(await Statamic.$app.config.globalProperties.$axios.get(`${t}/auto-alt-text/check`,{params:{asset_path:e,field:o}})).data}catch(t){console.error("Alt text check request error:",t);const a=((s=(r=t.response)==null?void 0:r.data)==null?void 0:s.message)||t.message||"Error checking status.";return{status:u,message:a}}}async function w(e,o,r){let s=0;return new Promise((t,a)=>{const c=window.setInterval(async()=>{if(s++,console.log(`Polling attempt ${s} for ${e}...`),s>A){clearInterval(c),a(new Error(__("auto-alt-text::messages.timeout")));return}const n=await $(e,o);switch(n.status){case _:clearInterval(c),console.log("Alt text ready:",n.caption),Statamic.$toast.success(__("auto-alt-text::messages.success")),r(n.caption),t();break;case x:break;case f:clearInterval(c),a(new Error(n.message||__("auto-alt-text::messages.asset_not_found")));break;case u:default:clearInterval(c),a(new Error(n.message||__("auto-alt-text::messages.polling_error")));break}},h)})}Statamic.booting(()=>{console.log("Statamic Auto Alt Text Addon Initializing...");const o=(Statamic.$config.get("autoAltText")||{}).enabledFields||["alt","alt_text","alternative_text"],r=__("auto-alt-text::messages.generate_alt_text_action");Statamic.$fieldActions.add("text-fieldtype",{title:r,icon:"image",visible:s=>{const t=window.location.pathname;return p(t,l())&&o.includes(s.handle)},run:async s=>{const{handle:t,update:a}=s,c=window.location.pathname,n=m(c,l());if(!n){Statamic.$toast.error(__("auto-alt-text::messages.cannot_determine_asset_path"));return}try{Statamic.$toast.info(__("auto-alt-text::messages.generation_started"));const i=await S(n,t);if(!i.success){const d=i.message||__("auto-alt-text::messages.trigger_failed");Statamic.$toast.error(d);return}await w(n,t,a)}catch(i){console.error("Error during alt text generation:",i),Statamic.$toast.error(i.message||__("auto-alt-text::messages.unexpected_error"))}}}),console.log("Statamic Auto Alt Text Field Action Registered for text-fieldtype.")});
