function d(s,o="/cp"){const a=o.replace(/\/$/,"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),t=new RegExp(`^${a}/assets/browse/([^/]+)/(.+?)(?:/edit)?$`),e=s.match(t);return e&&e[1]&&e[2]?`${e[1]}::${e[2]}`:null}function p(s){return s.includes("/assets/")||s.includes("/browse/")}const m="ready",_="pending",x="not_found",g="error",f=1e3,A=15;function l(){return Statamic.$config.get("cpRoot")||"/cp"}async function $(s,o){var r,a;try{const t=l().replace(/\/$/,"");return(await Statamic.$app.config.globalProperties.$axios.post(`${t}/auto-alt-text/generate`,{asset_path:s,field:o})).data}catch(t){return console.error("Alt text trigger request error:",t),{success:!1,message:((a=(r=t.response)==null?void 0:r.data)==null?void 0:a.message)||t.message||"Error communicating with server."}}}async function S(s,o){var r,a;try{const t=l().replace(/\/$/,"");return(await Statamic.$app.config.globalProperties.$axios.get(`${t}/auto-alt-text/check`,{params:{asset_path:s,field:o}})).data}catch(t){console.error("Alt text check request error:",t);const e=((a=(r=t.response)==null?void 0:r.data)==null?void 0:a.message)||t.message||"Error checking status.";return{status:g,message:e}}}async function h(s,o,r){let a=0;return new Promise((t,e)=>{const c=window.setInterval(async()=>{if(a++,console.log(`Polling attempt ${a} for ${s}...`),a>A){clearInterval(c),e(new Error(__("auto-alt-text::messages.timeout")));return}const n=await S(s,o);switch(n.status){case m:clearInterval(c),console.log("Alt text ready:",n.caption),Statamic.$toast.success(__("auto-alt-text::messages.success")),r(n.caption),t();break;case _:break;case x:clearInterval(c),e(new Error(n.message||__("auto-alt-text::messages.asset_not_found")));break;case g:default:clearInterval(c),e(new Error(n.message||__("auto-alt-text::messages.polling_error")));break}},f)})}Statamic.booting(()=>{console.log("Statamic Auto Alt Text Addon Initializing...");const o=(Statamic.$config.get("autoAltText")||{}).enabledFields||["alt","alt_text","alternative_text"],r=__("auto-alt-text::messages.generate_alt_text_action");Statamic.$fieldActions.add("text-fieldtype",{title:r,icon:"image",visible:a=>{const t=window.location.pathname;return p(t)&&o.includes(a.handle)},run:async a=>{const{handle:t,update:e}=a,c=window.location.pathname,n=d(c,l());if(!n){Statamic.$toast.error(__("auto-alt-text::messages.cannot_determine_asset_path"));return}try{Statamic.$toast.info(__("auto-alt-text::messages.generation_started"));const i=await $(n,t);if(!i.success){const u=i.message||__("auto-alt-text::messages.trigger_failed");Statamic.$toast.error(u);return}await h(n,t,e)}catch(i){console.error("Error during alt text generation:",i),Statamic.$toast.error(i.message||__("auto-alt-text::messages.unexpected_error"))}}}),console.log("Statamic Auto Alt Text Field Action Registered for text-fieldtype.")});
