const d="ready",p="pending",_="not_found",g="error";function m(s){return s.includes("/assets/")||s.includes("/browse/")}function l(){return Statamic.$config.get("cpUrl")||"/cp"}function x(s){const a=l().replace(/\/$/,"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`^${a}/assets/browse/([^/]+)/(.+?)(?:/edit)?$`),t=s.match(e);return t&&t[1]&&t[2]?`${t[1]}::${t[2]}`:(console.error("Could not determine Asset Container and Path from URL pattern:",s),null)}async function A(s,n){var a,e;try{const t=l().replace(/\/$/,"");return(await Statamic.$app.config.globalProperties.$axios.post(`${t}/auto-alt-text/generate`,{asset_path:s,field:n})).data}catch(t){return console.error("Alt text trigger request error:",t),{success:!1,message:((e=(a=t.response)==null?void 0:a.data)==null?void 0:e.message)||t.message||"Error communicating with server."}}}async function f(s,n){var a,e;try{const t=l().replace(/\/$/,"");return(await Statamic.$app.config.globalProperties.$axios.get(`${t}/auto-alt-text/check`,{params:{asset_path:s,field:n}})).data}catch(t){console.error("Alt text check request error:",t);const r=((e=(a=t.response)==null?void 0:a.data)==null?void 0:e.message)||t.message||"Error checking status.";return{status:g,message:r}}}async function S(s,n,a){let e=0;return new Promise((t,r)=>{const c=window.setInterval(async()=>{if(e++,console.log(`Polling attempt ${e} for ${s}...`),e>15){clearInterval(c),r(new Error(__("auto-alt-text::messages.timeout")));return}const o=await f(s,n);switch(o.status){case d:clearInterval(c),console.log("Alt text ready:",o.caption),Statamic.$toast.success(__("auto-alt-text::messages.success")),a(o.caption),t();break;case p:break;case _:clearInterval(c),r(new Error(o.message||__("auto-alt-text::messages.asset_not_found")));break;case g:default:clearInterval(c),r(new Error(o.message||__("auto-alt-text::messages.polling_error")));break}},1e3)})}Statamic.booting(()=>{console.log("Statamic Auto Alt Text Addon Initializing...");const n=(Statamic.$config.get("autoAltText")||{}).enabledFields||["alt","alt_text","alternative_text"],a=__("auto-alt-text::messages.generate_alt_text_action");Statamic.$fieldActions.add("text-fieldtype",{title:a,icon:"image",visible:e=>{const t=window.location.pathname;return m(t)&&n.includes(e.handle)},run:async e=>{const{handle:t,update:r}=e,c=window.location.pathname,o=x(c);if(!o){Statamic.$toast.error(__("auto-alt-text::messages.cannot_determine_asset_path"));return}try{Statamic.$toast.info(__("auto-alt-text::messages.generation_started"));const i=await A(o,t);if(!i.success){const u=i.message||__("auto-alt-text::messages.trigger_failed");Statamic.$toast.error(u);return}await S(o,t,r)}catch(i){console.error("Error during alt text generation:",i),Statamic.$toast.error(i.message||__("auto-alt-text::messages.unexpected_error"))}}}),console.log("Statamic Auto Alt Text Field Action Registered for text-fieldtype.")});
